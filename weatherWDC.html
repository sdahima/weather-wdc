<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Weather WDC</title>
  <script src="https://cdn.jsdelivr.net/npm/tableauwdc@2.3.0/dist/tableauwdc.min.js"></script>
</head>
<body>
  <h2>Weather Data Connector</h2>
  <label>Enter City:</label>
  <input type="text" id="city" value="Dallas">
  <button onclick="getWeather()">Get Weather</button>

  <script>
    function getWeather() {
      const city = document.getElementById("city").value;
      tableau.connectionData = JSON.stringify({ city });
      tableau.connectionName = `Weather for ${city}`;
      tableau.submit();
    }

    (function () {
      const myConnector = tableau.makeConnector();

      myConnector.getSchema = function (schemaCallback) {
        const cols = [
          { id: "city", dataType: tableau.dataTypeEnum.string },
          { id: "temperature", dataType: tableau.dataTypeEnum.float },
          { id: "humidity", dataType: tableau.dataTypeEnum.float },
          { id: "description", dataType: tableau.dataTypeEnum.string }
        ];
        schemaCallback([{
          id: "weatherData",
          alias: "Weather Info",
          columns: cols
        }]);
      };

      myConnector.getData = function (table, doneCallback) {
        const data = JSON.parse(tableau.connectionData);
        const API_KEY = "YOUR_API_KEY"; // Replace with your OpenWeatherMap API Key
        const city = data.city;
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_KEY}&units=imperial`;

        fetch(url)
          .then(response => response.json())
          .then(json => {
            const row = {
              city: json.name,
              temperature: json.main.temp,
              humidity: json.main.humidity,
              description: json.weather[0].description
            };
            table.appendRows([row]);
            doneCallback();
          });
      };

      tableau.registerConnector(myConnector);
    })();
  </script>
</body>
</html>

